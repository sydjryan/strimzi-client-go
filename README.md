# strimzi-client-go

Strimzi client-go package for use with kubernetes controllers.

This is a **work in progress** and hopefully the generation of this package will be fully automated soon.

At the moment, the partially-automated process is:

1. Download the strimzi CRD yaml for the version of your choice:

    `wget https://github.com/strimzi/strimzi-kafka-operator/releases/download/${VERSION}/strimzi-crds-${VERSION}.yaml`.
1. For version 0.41.0, fix a typo* in the yaml:

    `sed -i '' 's/\\\\._\\\\-/\\\\\\\\._\\\\\\\\-/g' strimzi-crds-0.41.0.yaml`.
1. Use crd-codegen to generate types from the CRD YAML. Copy the `.go` files generated by this tool (in `generated/apis/` at the time of writing) into `apis/kafka.strimzi.io/v1beta2` or similar.
1. Run the provided `convert.py` script on all types. This converts the top-level struct for each type (i.e. Kafka, KafkaTopic, etc) to fit what controller-gen expects. It also replaces `map[string]interface{}` types with `map[string]string`, as kubernetes controller tools do not support the former.
    ```
    > types=( "Kafka" "KafkaBridge" "KafkaConnect" "KafkaConnector" "KafkaMirrorMaker" "KafkaMirrorMaker2" "KafkaNodePool" "KafkaRebalance" "KafkaTopic" "KafkaUser" "StrimziPodSet" )
    > for type in ${types[*]}; do; python convert.py apis/kafka.strimzi.io/v1beta2/$type.go v1beta2; done
    ```
    Check that the files were converted properly. You may have to delete unnecessary imports.
1. Convert int types to int32:

    ```sed -i 's/int `json/int32 `json'/g apis/kafka.strimzi.io/v1beta2/*``` (or on MacOS, ```sed -i '' 's/int `json/int32 `json/g' apis/kafka.strimzi.io/v1beta2/*```)
1. Ensure that `groupversion_info.go` registers all expected types in the scheme.
1. Finally run `controller-gen object paths=./...` to generate `DeepCopy` implementations. Make sure that GOPATH is in your PATH, or you may need to find where controller-gen is installed.


\* The Mirrormaker2 YAML definition in version 0.41.0 contains a malformed regexp validation. We need to fix the special character escaping before using the crd-codegen tool, or the tool will error.
